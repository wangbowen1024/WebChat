<!DOCTYPE html>
<html lang="zh">
<head>
    <title>Web Chat</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 引入 Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 Shiv 和 Respond.js 用于让 IE8 支持 HTML5元素和媒体查询 -->
    <!-- 注意： 如果通过 file://  引入 Respond.js 文件，则该文件无法起效果 -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <style>
        .pad-top {
            padding-top: 10px;
        }

        .no-border {
            border: 0px;
        }

        .information {
            border-radius: 5px;
            background-color: #5bc0de;

        }

        .middle {
            float: none;
            display: inline-block;
            vertical-align: middle;
        }


    </style>
    <script>

        var _nickname = "";
        var _uid = 0;
        var now_chat_id = 1;
        var now_chat_type = 'g';
        var flag = true;
        // websocket
        var websocket = null;

        function exit_user() {
            if (confirm('确定注销账号吗？')) {
                $.cookie("token", "",{expires: -1});
                location.href = "http://localhost"
            }
        }
        /*聊天窗口滚条设置最底下*/
        function down(id) {
            var scrollDom = document.getElementById(id);
            scrollDom.scrollTop = scrollDom.scrollHeight;
        }

        // 格式化时间
        function timeStamp2String(time){
            var datetime = new Date();
            datetime.setTime(time);
            var year = datetime.getFullYear();
            var month = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
            var date = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
            var hour = datetime.getHours()< 10 ? "0" + datetime.getHours() : datetime.getHours();
            var minute = datetime.getMinutes()< 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
            var second = datetime.getSeconds()< 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
            return year + "-" + month + "-" + date+" "+hour+":"+minute+":"+second;
        }
        // 查询记录
        function record() {
            $.ajax({
                headers: {
                    "token": $.cookie("token")//此处放置请求到的用户token
                },
                type: "POST",
                url: "http://localhost/recordServlet",
                dataType: "json",
                data: {type: now_chat_type, id: now_chat_id, userid: _uid},
                success: function (msg) {
                    $("#chatbox_1").html("");
                    for (var i = msg.length - 1; i >= 0; i--) {
                        var reMsg = "";
                        if (msg[i].uid == _uid) {
                            // 如果是自己的信息显示在右边
                            reMsg = '<div class="row">\n' +
                                '                        <!--信息-->\n' +
                                '                        <div style="padding-top: 5px">\n' +
                                '                            <div class="col-sm-7 col-md-offset-4" >\n' +
                                '                                <div style="text-align: right">'+msg[i].nickname+' (UID:'+msg[i].uid+') '+timeStamp2String(msg[i].sendtime)+'</div>\n' +
                                '                                <p class="information" style="padding: 5px">\n' + msg[i].content +
                                '                                </p>\n' +
                                '                            </div>\n' +
                                '                            <div class="col-sm-1"><img src="img/user.jpg" class="img-circle" style="height: 50px;width: 50px" alt="用户头像"></div>\n' +
                                '                        </div>\n' +
                                '                    </div>';
                        } else {
                            reMsg = '<div class="row">\n' +
                                '                        <!--信息-->\n' +
                                '                        <div style="padding-top: 5px">\n' +
                                '                            <div class="col-sm-1"><img src="img/user.jpg" class="img-circle" style="height: 50px;width: 50px" alt="用户头像"></div>\n' +
                                '                            <div>'+msg[i].nickname+' (UID:'+msg[i].uid+')  '+timeStamp2String(msg[i].sendtime)+'</div>\n' +
                                '                            <p class="col-sm-7 information" style="padding: 5px" >\n' + msg[i].content +
                                '                            </p>\n' +
                                '                        </div>\n' +
                                '                    </div>';
                        }
                        $("#chatbox_1").append(reMsg);
                    }
                    down("chatbox_1");
                }
            });
        }
        /*切换好友以及模式*/
        // {type:'g',nickanme:'BOW',uid:'1',giu:'1',content:'你好'}
        function choiceObject(t, id, name) {
            if (t == 1) {
                now_chat_type = 'p';
            } else if (t == 2) {
                now_chat_type = 'g'
            }
            now_chat_id = id;
            $("#chatBoxName").html(name);
            var idname = "fuid" + id;
            document.getElementById(idname).style.display = "none";
            record();
        }

    </script>

</head>

<body>
    <div class="container-fluid">
        <header id="header" class="row " style="background-color: #0f0f0f;color: white" >
            <div class="col-sm-2" style="padding-left: 30px"><h4 >Web Chat V1.0</h4></div>
            <div class="" style="text-align: right">
                <!--<button type="button" class="btn btn-default btn-sm middle">设置</button>
                <button type="button" class="btn btn-default btn-sm">退出</button>-->
                <a href="#"><span style="color: white">设置</span></a> |
                <a href="javascript:void(0);" onclick="exit_user()"><span style="color: white">退出</span></a>
            </div>
        </header>
        <div id="mainbody" class="row">
            <!--左侧栏-->
            <div id="leftbody" class="col-sm-3 test" style="background-color: #1c232f;color: white; overflow: auto;">
                <!--基本信息-->
                <div class="row pad-top">
                    <div class="col-sm-3">
                        <img src="img/user.jpg" class="img-circle img-responsive" alt="用户头像">
                    </div>
                    <div class="col-sm-9">
                        <h4><span id="nickname">***</span> (UID: <span id="username">*</span>)</h4>
                        <span class="label label-success">Online</span>
                    </div>
                </div>
                <!--查找-->
                <div class="input-group pad-top">
                    <input id="selectUID" type="text" class="form-control" placeholder="请输入对方UID添加好友">
                    <span id="selectBtn" class="input-group-addon" data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-search"></span></span>
                </div>
                <!-- 模态框（Modal） -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header" style="color: black">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                    &times;
                                </button>
                                <h4 class="modal-title" id="myModalLabel">
                                    添加好友
                                </h4>
                            </div>
                            <div class="modal-body" style="color: black">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon"> UID </span>
                                    <input id="friendId" type="text" class="form-control" placeholder="UID">
                                </div>
                                <h3 id="friendQue"></h3>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-addon">答案</span>
                                    <input id="friendAnswer" type="text" class="form-control" placeholder="请回答对方问题">
                                </div>
                                <h3>选择分组</h3>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="optionsRadios" id="op1" value="1" checked="checked">
                                        我的好友
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="optionsRadios" id="op2" value="2">
                                        家人
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="optionsRadios" id="op3" value="3">
                                        同事
                                    </label>
                                </div>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="optionsRadios" id="op4" value="4">
                                        同学
                                    </label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                <button id="addFriendBtn" type="button" class="btn btn-primary">提交申请</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal -->
                </div>
                <!--好友列表-->
                <div class="pad-top">
                    <ul id="list_1" class="list-group" style="color: black;">
                        <li class="list-group-item disabled no-border"><span style="font-size: 150%">好友</span></li>
                        <li class="list-group-item no-border" >
                            <div class="panel-heading">
                                <span id="friend_i_1" class="glyphicon glyphicon-menu-right"></span>
                                <span id="friend_t_1" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">我的好友 </span>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse">
                                <div class="panel-body">FRIEND1<span id="" class="badge" style="background-color:red;margin-left: 5px;display: none">!</span></div>
                            </div>
                        </li>
                        <li class="list-group-item no-border">
                            <div class="panel-heading">
                                <span id="friend_i_2" class="glyphicon glyphicon-menu-right"></span>
                                <span id="friend_t_2" data-toggle="collapse" data-parent="#accordion" href="#collapse2">家人 </span>
                            </div>
                            <div id="collapse2" class="panel-collapse collapse">
                                <div class="panel-body">FRIEND1</div>
                            </div>
                        </li>
                        <li class="list-group-item no-border">
                            <div class="panel-heading">
                                <span id="friend_i_3" class="glyphicon glyphicon-menu-right"></span>
                                <span id="friend_t_3" data-toggle="collapse" data-parent="#accordion" href="#collapse3">同事 </span>
                            </div>
                            <div id="collapse3" class="panel-collapse collapse">
                                <div class="panel-body">FRIEND1</div>
                            </div>
                        </li>
                        <li class="list-group-item no-border">
                            <div class="panel-heading">
                                <span id="friend_i_4" class="glyphicon glyphicon-menu-right"></span>
                                <span id="friend_t_4" data-toggle="collapse" data-parent="#accordion" href="#collapse4">同学 </span>
                            </div>
                            <div id="collapse4" class="panel-collapse collapse">
                                <div class="panel-body">FRIEND1</div>
                            </div>
                        </li>


                    </ul>
                    <ul id="list_2" class="list-group" style="color: black;">
                        <li class="list-group-item disabled no-border"><span style="font-size: 150%">群聊</span></li>
                        <li class="list-group-item no-border" onclick="choiceObject(2, 1,'Public Chat Room')">Public Chat Room</li>
                    </ul>
                </div>
            </div>
            <!--右侧栏-->
            <div class="col-sm-9 test">
                <!--聊天框名称-->
                <div class="row" style="text-align: center;background-color: #333333;color: white"><h4 id="chatBoxName">Public Chat Room</h4></div>
                <!--内容-->
                <div id="chatbox_1" style="overflow: auto;overflow-x:hidden">

                </div>
                <!--分割线-->
                <div class="row" style="background-color: #333333;height: 10px"></div>
                <!--输入框-->
                <div>
                    <div style="padding-top: 10px">
                        <textarea id="text_area" class="form-control" style="resize: none;"></textarea>
                    </div>
                    <!--发送按钮-->
                    <div class="text-right" style="padding-top: 10px">
                        <!--<button type="button" class="btn btn-default">关闭</button>-->
                        <button id="send" type="button" class="btn btn-primary">发送</button>
                    </div>
                </div>
            </div>
        </div>
<!--        <footer id="footer" class="footer navbar-fixed-bottom" style="background-color: #5bc0de;text-align: center">
            <span>Copyright © 2013-2019 菜鸟教程  runoob.com All Rights Reserved. 备案号：闽ICP备15012807号-1</span>
        </footer>-->
    </div>

<!-- jQuery (Bootstrap 的 JavaScript 插件需要引入 jQuery) -->
<script src="https://code.jquery.com/jquery.js"></script>
<!-- 包括所有已编译的插件 -->
<script src="js/bootstrap.min.js"></script>
<script>
    var windows_width = window.innerWidth;
    var windows_height =window.innerHeight;
    var h = windows_height /*- parseInt($("#footer").css("height"))*/ - parseInt($("#header").css("height"));
    $("#chatbox_1").css("height", h * 0.7);
    $("#leftbody").css("height", h);
    $("#text_area").css("height", h * 0.14);


    window.onresize = function () {
        var windows_width = window.innerWidth;
        var windows_height =window.innerHeight;
        var h = windows_height /*- parseInt($("#footer").css("height"))*/ - parseInt($("#header").css("height"));
        $("#leftbody").css("height", h);
        $("#chatbox_1").css("height", h * 0.7);
        $("#text_area").css("height", h * 0.14);
    };
</script>
<script src="js/jquery.cookie.js" type="text/javascript"></script>
<script>

    $(function () {

        /*加载好友列表*/
        function updateFriendList() {
            $.ajax({
                type: "POST",
                url: "http://localhost/friendList",
                dataType: "json",
                data: {},
                beforeSend: function (request) {
                    request.setRequestHeader("token", $.cookie("token"));
                },
                success: function (msg) {
                    $("#collapseOne").html("");
                    $("#collapse2").html("");
                    $("#collapse3").html("");
                    $("#collapse4").html("");

                    var count1 = 0;
                    var count2 = 0;
                    var count3 = 0;
                    var count4 = 0;

                    for (var i = 0; i < msg.length; i++) {
                        if (msg[i].cid == 1) {
                            $("#collapseOne").append('<div class="panel-body" onclick="choiceObject(1, '+msg[i].fuid+', \''+msg[i].nickname+'\')">'+msg[i].nickname+'(UID:'+msg[i].fuid+')<span id="fuid'+msg[i].fuid+'" class="badge" style="background-color:red;margin-left: 5px;display: none">!</span></div>');
                            count1 += 1;
                        } else if (msg[i].cid == 2) {
                            $("#collapse2").append('<div class="panel-body" onclick="choiceObject(1, '+msg[i].fuid+', \''+msg[i].nickname+'\')">'+msg[i].nickname+'(UID:'+msg[i].fuid+')<span id="fuid'+msg[i].fuid+'" class="badge" style="background-color:red;margin-left: 5px;display: none">!</span></div>');
                            count2 += 1;
                        } else if (msg[i].cid == 3) {
                            $("#collapse3").append('<div class="panel-body" onclick="choiceObject(1, '+msg[i].fuid+', \''+msg[i].nickname+'\')">'+msg[i].nickname+'(UID:'+msg[i].fuid+')<span id="fuid'+msg[i].fuid+'" class="badge" style="background-color:red;margin-left: 5px;display: none">!</span></div>');
                            count3 += 1;
                        } else if (msg[i].cid == 4) {
                            $("#collapse4").append('<div class="panel-body" onclick="choiceObject(1, '+msg[i].fuid+', \''+msg[i].nickname+'\')">'+msg[i].nickname+'(UID:'+msg[i].fuid+')<span id="fuid'+msg[i].fuid+'" class="badge" style="background-color:red;margin-left: 5px;display: none">!</span></div>');
                            count4 += 1;
                        }
                    }

                    $("#friend_t_1").html("我的好友" + "(" + count1 + ")");
                    $("#friend_t_2").html("家人" + "(" + count2 + ")");
                    $("#friend_t_3").html("同事" + "(" + count3 + ")");
                    $("#friend_t_4").html("同学" + "(" + count4 + ")");
                }
            });
        }
        updateFriendList();

        /*提交问题答案*/
        $("#addFriendBtn").click(function () {
            var op = 0;
            if ($("#op1").prop("checked")) {
                op = 1;
            } else if ($("#op2").prop("checked")) {
                op = 2;
            } else if ($("#op3").prop("checked")) {
                op = 3;
            } else if ($("#op4").prop("checked")) {
                op = 4
            }
            $.ajax({
                type: "POST",
                url: "http://localhost/addFriend",
                dataType: "json",
                data: {fuid: $("#friendId").val(), answer:$("#friendAnswer").val(), cid: op},
                beforeSend: function (request) {
                    request.setRequestHeader("token", $.cookie("token"));
                },
                success: function (msg) {
                    updateFriendList();
                    alert(msg.content);
                }
            });
        });

        /*查找好友*/
        $("#selectBtn").click(function () {
            $.ajax({
                headers: {
                    "token": $.cookie("token")//此处放置请求到的用户token
                },
                type: "POST",
                url: "http://localhost/selectFriend",
                dataType: "json",
                data: {uid: $("#selectUID").val()},
                success: function (msg) {
                    if (msg.type == 0) {
                        alert(msg.content);
                    }else if (msg.type == 2) {
                        alert(msg.content);
                    } else if (msg.type == 1) {
                        $("#friendId").val($("#selectUID").val());
                        $("#friendQue").html("问题：" + msg.content);
                    }
                }
            });
        });

        /*列表前的小标志*/
        $("#friend_t_1").click(function () {
            if ($("#friend_i_1").hasClass("glyphicon-chevron-down")) {
                $("#friend_i_1").removeClass("glyphicon-chevron-down").addClass("glyphicon-menu-right");
            } else if ($("#friend_i_1").hasClass("glyphicon-menu-right")) {
                $("#friend_i_1").removeClass("glyphicon-menu-right").addClass("glyphicon-chevron-down");
            }
        });
        $("#friend_t_2").click(function () {
            if ($("#friend_i_2").hasClass("glyphicon-chevron-down")) {
                $("#friend_i_2").removeClass("glyphicon-chevron-down").addClass("glyphicon-menu-right");
            } else if ($("#friend_i_2").hasClass("glyphicon-menu-right")) {
                $("#friend_i_2").removeClass("glyphicon-menu-right").addClass("glyphicon-chevron-down");
            }
        });
        $("#friend_t_3").click(function () {
            if ($("#friend_i_3").hasClass("glyphicon-chevron-down")) {
                $("#friend_i_3").removeClass("glyphicon-chevron-down").addClass("glyphicon-menu-right");
            } else if ($("#friend_i_3").hasClass("glyphicon-menu-right")) {
                $("#friend_i_3").removeClass("glyphicon-menu-right").addClass("glyphicon-chevron-down");
            }
        });
        $("#friend_t_4").click(function () {
            if ($("#friend_i_4").hasClass("glyphicon-chevron-down")) {
                $("#friend_i_4").removeClass("glyphicon-chevron-down").addClass("glyphicon-menu-right");
            } else if ($("#friend_i_4").hasClass("glyphicon-menu-right")) {
                $("#friend_i_4").removeClass("glyphicon-menu-right").addClass("glyphicon-chevron-down");
            }
        });


        /*发送按钮*/
        $("#send").click(function () {
            send();
        });
        //发送消息
        function send() {
            // {type:'g',nickanme:'BOW',uid:'1',giu:'1',content:'你好'}
            var message = document.getElementById('text_area').value;
            var send_msg = "";
            if (now_chat_type == "g") {
                send_msg = "{type:'" + now_chat_type + "',nickname:'" + _nickname + "',uid:" + _uid + ",gid:" + now_chat_id + ",content:'" + message + "'}";
            } else if (now_chat_type == "p") {
                send_msg = "{type:'" + now_chat_type + "',nickname:'" + _nickname + "',uid:" + _uid + ",tuid:" + now_chat_id + ",content:'" + message + "'}";
            }
            websocket.send(send_msg);
            var myMsg = '<div class="row">\n' +
                '                        <!--信息-->\n' +
                '                        <div style="padding-top: 5px">\n' +
                '                            <div class="col-sm-7 col-md-offset-4" >\n' +
                '                                <div style="text-align: right">'+_nickname+' (UID:'+_uid+') '+timeStamp2String(new Date().getTime())+'</div>\n' +
                '                                <p class="information" style="padding: 5px">\n' + message +
                '                                </p>\n' +
                '                            </div>\n' +
                '                            <div class="col-sm-1"><img src="img/user.jpg" class="img-circle" style="height: 50px;width: 50px" alt="用户头像"></div>\n' +
                '                        </div>\n' +
                '                    </div>';
            $("#chatbox_1").append(myMsg);
            document.getElementById('text_area').value = "";
            down("chatbox_1");
        }

        $.ajax({
            headers: {
                "token": $.cookie("token")//此处放置请求到的用户token
            },
            type: "POST",
            async: false,
            url: "http://localhost/userInfo",//请求url
            contentType: "application/json;charset=utf-8",
            /*beforeSend: function (request) {
                request.setRequestHeader("token", $.cookie("token"));
            },*/
            success: function (msg) {
                if (msg == "http://localhost") {
                    location.href = msg;
                }
               // alert(msg + "!!!");
                // 获取用户信息
                $("#nickname").html(msg.nickname);
                _nickname = msg.nickname;
                $("#username").html(msg.uid);
                _uid = msg.uid;

                //判断当前浏览器是否支持WebSocket
                if ('WebSocket' in window) {
                    websocket = new WebSocket("ws://localhost/websocket/" + _uid);
                } else {
                    alert('当前浏览器 Not support websocket')
                }
                //连接发生错误的回调方法
                websocket.onerror = function () {
                    alert("WebSocket连接发生错误");
                };


                //接收到消息的回调方法
                websocket.onmessage = function (event) {
                    // {type:'g',nickname:'BOW',uid:'1',gid:'1',content:'你好'}
                    var array = event.data.split(",");
                    if (array[0] == "g") {
                        if (now_chat_type == "g" && now_chat_id == array[3]) {
                            var reMsg = '<div class="row">\n' +
                                '                        <!--信息-->\n' +
                                '                        <div style="padding-top: 5px">\n' +
                                '                            <div class="col-sm-1"><img src="img/user.jpg" class="img-circle" style="height: 50px;width: 50px" alt="用户头像"></div>\n' +
                                '                            <div>' + array[1] + ' (UID:' + array[2] + ') ' + timeStamp2String(new Date().getTime()) + '</div>\n' +
                                '                            <p class="col-sm-7 information" style="padding: 5px" >\n' + array[4] +
                                '                            </p>\n' +
                                '                        </div>\n' +
                                '                    </div>';
                            $("#chatbox_1").append(reMsg);
                        } else {
                            // 添加未读消息提示（徽章）
                            // 暂时仅支持好友
                        }
                    } else if (array[0] == "p") {
                       // alert(now_chat_type + " and " + now_chat_id + "and " + array[2]);
                        if (now_chat_type == "p" && now_chat_id == array[2]) {
                            var reMsg = '<div class="row">\n' +
                                '                        <!--信息-->\n' +
                                '                        <div style="padding-top: 5px">\n' +
                                '                            <div class="col-sm-1"><img src="img/user.jpg" class="img-circle" style="height: 50px;width: 50px" alt="用户头像"></div>\n' +
                                '                            <div>' + array[1] + ' (UID:' + array[2] + ') ' + timeStamp2String(new Date().getTime()) + '</div>\n' +
                                '                            <p class="col-sm-7 information" style="padding: 5px" >\n' + array[4] +
                                '                            </p>\n' +
                                '                        </div>\n' +
                                '                    </div>';
                            $("#chatbox_1").append(reMsg);
                        } else {
                            // 添加未读消息提示（徽章）
                            var idname = "fuid" + array[2];
                            document.getElementById(idname).style.display = "inline";
                        }
                    }
                    down("chatbox_1");
                };

                //连接关闭的回调方法
                websocket.onclose = function () {
                    $("#chatbox_1").append("<span style='text-align: center;color: red'>WebSocket连接关闭!</span>");

                };

                //连接成功建立的回调方法
                websocket.onopen = function () {
                    /*var html = $("#deblock_udid1").html();*/
                    $("#chatbox_1").append("<span style='text-align: center;color: red'>WebSocket连接成功!</span>");
                };


            }
        });
        //关闭WebSocket连接
        function closeWebSocket() {
            websocket.close();
        }
        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            closeWebSocket();
        };


        record();

    });
</script>
</body>
</html>